name: Scrape and Publish Holidays

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests beautifulsoup4
      
      - name: Run scraper
        run: python kalbi.py
      
      - name: Create public directory
        run: mkdir -p public
      
      - name: Copy holidays JSON
        run: cp nietypowe_swieta.json public/holidays.json
      
      - name: Create today endpoint
        run: |
          python3 -c "
          import json
          from datetime import datetime
          
          with open('nietypowe_swieta.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          now = datetime.now()
          today = [h for h in data if h['day'] == now.day and h['month'] == now.month]
          
          with open('public/today.json', 'w', encoding='utf-8') as f:
              json.dump(today, f, ensure_ascii=False, indent=2)
          "
      
      - name: Create HTML page
        run: |
          cat > public/index.html <<'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>Kalbi Holidays API</title>
          </head>
          <body>
              <h1>Kalbi Holidays API</h1>
              <p>Endpoints:</p>
              <ul>
                  <li><a href="today.json">today.json</a> - Dzisiejsze swiento</li>
                  <li><a href="holidays.json">holidays.json</a> - Wszystkie swienta</li>
              </ul>
              <h2>Home Assistant Config</h2>
              <pre>
          sensor:
            - platform: rest
              name: Dzisiejsze Swiento
              resource: https://jeakob.github.io/kalbi-holidays/today.json
              method: GET
              scan_interval: 43200
              </pre>
          </body>
          </html>
          EOF
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'public'
      
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
