name: Scrape and Publish Holidays

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests beautifulsoup4
      
      - name: Run scraper
        run: python kalbi.py
      
      - name: Create public directory
        run: mkdir -p public
      
      - name: Copy holidays JSON
        run: cp nietypowe_swieta.json public/holidays.json
      
      - name: Create today.json
        run: |
          python3 << 'PYTHON_EOF'
          import json
          from datetime import datetime
          
          with open('nietypowe_swieta.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          now = datetime.now()
          today = [h for h in data if h['day'] == now.day and h['month'] == now.month]
          
          with open('public/today.json', 'w', encoding='utf-8') as f:
              json.dump(today, f, ensure_ascii=False, indent=2)
          PYTHON_EOF
      
      - name: Create index.html
        run: |
          cat > public/index.html << 'HTML_EOF'
          <!DOCTYPE html>
          <html lang="pl">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Kalbi Holidays API</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      max-width: 900px;
                      margin: 0 auto;
                      padding: 40px 20px;
                      line-height: 1.6;
                      color: #333;
                  }
                  h1 { color: #2c3e50; margin-bottom: 10px; }
                  h2 { color: #34495e; margin-top: 40px; }
                  .subtitle { color: #7f8c8d; margin-bottom: 40px; }
                  .endpoint {
                      background: #f8f9fa;
                      padding: 20px;
                      margin: 15px 0;
                      border-radius: 8px;
                      border-left: 4px solid #3498db;
                  }
                  .endpoint h3 { margin-top: 0; color: #2c3e50; }
                  .endpoint code {
                      background: #e8f4f8;
                      padding: 4px 8px;
                      border-radius: 4px;
                      font-family: 'Courier New', monospace;
                      color: #2980b9;
                  }
                  .endpoint a {
                      color: #3498db;
                      text-decoration: none;
                      font-weight: 500;
                  }
                  .endpoint a:hover { text-decoration: underline; }
                  pre {
                      background: #2c3e50;
                      color: #ecf0f1;
                      padding: 20px;
                      border-radius: 8px;
                      overflow-x: auto;
                      font-size: 14px;
                      line-height: 1.5;
                  }
                  .config-note {
                      background: #fff3cd;
                      border-left: 4px solid #ffc107;
                      padding: 15px;
                      margin: 20px 0;
                      border-radius: 4px;
                  }
                  footer {
                      margin-top: 60px;
                      padding-top: 20px;
                      border-top: 1px solid #ddd;
                      color: #7f8c8d;
                      text-align: center;
                  }
                  footer a { color: #3498db; }
              </style>
          </head>
          <body>
              <h1>ğŸ‰ Kalbi Holidays API</h1>
              <p class="subtitle">API dla nietypowych Å›wiÄ…t - aktualizowane codziennie o 2:00 UTC</p>
              
              <h2>ğŸ“¡ DostÄ™pne endpointy</h2>
              
              <div class="endpoint">
                  <h3>ğŸ“… Dzisiejsze Å›wiÄ™to</h3>
                  <p><code>GET /today.json</code></p>
                  <p>Zwraca Å›wiÄ™to obchodzone dzisiaj (lub pustÄ… tablicÄ™ jeÅ›li brak)</p>
                  <p><a href="today.json" target="_blank">â†’ Zobacz dzisiejsze Å›wiÄ™to</a></p>
              </div>
              
              <div class="endpoint">
                  <h3>ğŸ“‹ Wszystkie Å›wiÄ™ta</h3>
                  <p><code>GET /holidays.json</code></p>
                  <p>Zwraca peÅ‚nÄ… listÄ™ wszystkich nietypowych Å›wiÄ…t w roku</p>
                  <p><a href="holidays.json" target="_blank">â†’ Zobacz wszystkie Å›wiÄ™ta</a></p>
              </div>
              
              <h2>ğŸ  Integracja z Home Assistant</h2>
              
              <div class="config-note">
                  <strong>ğŸ“ Instrukcja:</strong> Dodaj poniÅ¼szÄ… konfiguracjÄ™ do pliku <code>configuration.yaml</code>
              </div>
              
              <pre>sensor:
  - platform: rest
    name: Dzisiejsze ÅšwiÄ™to
    resource: https://jeakob.github.io/kalbi-holidays/today.json
    method: GET
    value_template: >
      {% if value_json[0].name is defined %}
        {{ value_json[0].name }}
      {% else %}
        Brak nietypowego Å›wiÄ™ta
      {% endif %}
    json_attributes_path: $[0]
    json_attributes:
      - description
      - link
      - day
      - month
      - name
    scan_interval: 43200</pre>
              
              <h2>ğŸ“Š Format danych</h2>
              
              <p>KaÅ¼de Å›wiÄ™to zawiera nastÄ™pujÄ…ce pola:</p>
              <pre>{
  "name": "Åšwiatowy DzieÅ„ Pizzy",
  "description": "Opis Å›wiÄ™ta...",
  "link": "https://...",
  "day": 9,
  "month": 2
}</pre>
              
              <footer>
                  <p>Dane pochodzÄ… z <a href="https://www.calendarr.com/polska/kalendarz-swiat-nietypowych/" target="_blank">Calendarr.com</a></p>
                  <p>Kod ÅºrÃ³dÅ‚owy: <a href="https://github.com/jeakob/kalbi-holidays" target="_blank">GitHub</a></p>
              </footer>
          </body>
          </html>
          HTML_EOF
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'public'
      
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
