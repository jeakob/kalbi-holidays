name: Scrape and Publish Holidays

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests beautifulsoup4
      
      - name: Run scraper
        run: python kalbi.py
      
      - name: Create public directory
        run: mkdir -p public
      
      - name: Copy holidays JSON
        run: cp nietypowe_swieta.json public/holidays.json
      
      - name: Create today.json
        run: |
          python3 << 'PYEOF'
          import json
          from datetime import datetime
          
          with open('nietypowe_swieta.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          now = datetime.now()
          today = [h for h in data if h['day'] == now.day and h['month'] == now.month]
          
          with open('public/today.json', 'w', encoding='utf-8') as f:
              json.dump(today, f, ensure_ascii=False, indent=2)
          PYEOF
      
      - name: Create index.html
        run: |
          cat > public/index.html << 'ENDHTML'
          <!DOCTYPE html>
          <html lang="pl">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Kalbi Holidays API</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      max-width: 900px;
                      margin: 0 auto;
                      padding: 40px 20px;
                      line-height: 1.6;
                      color: #333;
                  }
                  h1 { color: #2c3e50; }
                  .endpoint {
                      background: #f8f9fa;
                      padding: 20px;
                      margin: 15px 0;
                      border-radius: 8px;
                      border-left: 4px solid #3498db;
                  }
                  pre {
                      background: #2c3e50;
                      color: #ecf0f1;
                      padding: 20px;
                      border-radius: 8px;
                      overflow-x: auto;
                  }
              </style>
          </head>
          <body>
              <h1>Kalbi Holidays API</h1>
              <p>API dla nietypowych swiat - aktualizowane codziennie o 2:00 UTC</p>
              
              <h2>Dostepne endpointy</h2>
              
              <div class="endpoint">
                  <h3>Dzisiejsze swието</h3>
                  <p><code>GET /today.json</code></p>
                  <p><a href="today.json">Zobacz dzisiejsze swiento</a></p>
              </div>
              
              <div class="endpoint">
                  <h3>Wszystkie swieta</h3>
                  <p><code>GET /holidays.json</code></p>
                  <p><a href="holidays.json">Zobacz wszystkie swieta</a></p>
              </div>
              
              <h2>Home Assistant</h2>
              <pre>
sensor:
  - platform: rest
    name: Dzisiejsze Swiento
    resource: https://jeakob.github.io/kalbi-holidays/today.json
    scan_interval: 43200
              </pre>
              
              <p><a href="https://github.com/jeakob/kalbi-holidays">GitHub</a></p>
          </body>
          </html>
          ENDHTML
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'public'
      
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
